{"version":3,"sources":["../src/State.js"],"names":[],"mappings":"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","file":"State.js","sourcesContent":["import {funcMeta} from \"./utils\";\nimport {Controller} from \"./Controller\";\n\nconst DEFAULT_SUFFIX = \"Controller\";\n\n\n\n/*\n@param {Object}  opts - The options\n@param {string}  [opts.name] - The name of the state.\n@param {string}  [opts.bindTo] - Bind the controller to the provided name.\n@param {string}  [opts.url] - The url of the state.\n@param {Boolean} [opts.abstract] - True for abstract states.\n@param {string}  [opts.template] - An angular template.\n@param {string}  [opts.templateUrl] - A URL to an angular template.\n@param {State[]} [opts.children] - List of child states.\n@param {string}  [opts.controllerName] - The name of the controller as seen by angular.\n*/\nexport function State(opts) {\n  if (typeof opts === \"function\") {\n    let constructor = opts; opts = null;\n    return register(constructor);\n  }\n\n  opts = (opts || {});\n\n  return register;\n\n  function register(constructor) {\n    registerLock(constructor);\n    Controller(constructor, { name: opts.controllerName });\n\n    let meta = stateMeta(constructor);\n    let superMeta = stateMeta(meta.superClass) || { state: {} };\n\n    let prototype = constructor.prototype;\n    if (prototype.activate) {\n      State.onActivate(prototype, \"activate\", { value: prototype.activate });\n    }\n    if (prototype.attach) {\n      State.onAttach(prototype, \"attach\", { value: prototype.attach });\n    }\n    if (prototype.detach) {\n      State.onDetach(prototype, \"detach\", { value: prototype.detach });\n    }\n\n    if (superMeta.state.callbacks) {\n      meta.state.callbacks.onActivate = superMeta.state.callbacks.onActivate\n        .concat(meta.state.callbacks.onActivate);\n      meta.state.callbacks.onAttach = superMeta.state.callbacks.onAttach\n        .concat(meta.state.callbacks.onAttach);\n      meta.state.callbacks.onDetach = superMeta.state.callbacks.onDetach\n        .concat(meta.state.callbacks.onDetach);\n    }\n\n    if (opts.children === false) {\n      meta.state.children = null;\n    } else if (opts.children) {\n      meta.state.children = opts.children;\n    } else if (superMeta.state.children) {\n      meta.state.children = superMeta.state.children;\n    }\n    if (!meta.state.children) {\n      meta.state.children = [];\n    }\n\n    let inheritedTemplated = false;\n    if (opts.template === false) {\n      meta.state.template = null;\n    } else if (opts.template) {\n      meta.state.template = opts.template;\n    } else if (opts.templateUrl) {\n      meta.state.templateUrl = opts.templateUrl;\n    } else if (superMeta.state.template) {\n      inheritedTemplated = true;\n      meta.state.template = superMeta.state.template;\n    } else if (superMeta.state.templateUrl) {\n      inheritedTemplated = true;\n      meta.state.templateUrl = superMeta.state.templateUrl;\n    }\n    if (!meta.state.template && !meta.state.templateUrl) {\n      if (meta.state.children.length > 0) {\n        meta.state.template = `<ui-view></ui-view>`;\n      } else {\n        meta.state.template = ``;\n      }\n    }\n\n    if (opts.name) {\n      meta.state.name = opts.name;\n    } else {\n      let name = meta.name;\n      name = name[0].toLowerCase() + name.substr(1, name.length - DEFAULT_SUFFIX.length - 1);\n      meta.state.name = name;\n    }\n\n    if (opts.bindTo) {\n      if (inheritedTemplated) {\n        throw Error(\"bindTo cannot be used with inherited templates\");\n      }\n      meta.state.bindTo = opts.bindTo;\n    } else {\n      if (inheritedTemplated) {\n        meta.state.bindTo = superMeta.state.bindTo;\n      } else {\n        meta.state.bindTo = meta.state.name;\n      }\n    }\n\n    if (opts.url === false) {\n      if (opts.url) {\n        meta.state.url = opts.url;\n      } else if (superMeta.state.url) {\n        meta.state.url = superMeta.state.url;\n      }\n    }\n\n    if (opts.abstract === undefined) {\n      meta.state.abstract = superMeta.state.abstract;\n    } else if (opts.abstract === true) {\n      meta.state.abstract = true;\n    } else if (opts.abstract === false) {\n      meta.state.abstract = false;\n    }\n\n  }\n}\n\nfunction stateMeta(constructor) {\n  if (!constructor) {\n    return null;\n  }\n\n  let meta = funcMeta(constructor);\n\n  if (meta.state) {\n    return meta;\n  }\n\n  meta.state = {\n    callbacks: {\n      onActivate: [],\n      onAttach:   [],\n      onDetach:   [],\n    },\n  };\n\n  return meta;\n}\n\nfunction registerLock(constructor) {\n  let meta = stateMeta(constructor);\n\n  if (meta.state.registered) {\n    throw \"@State() can only be used once!\";\n  }\n\n  meta.state.registered = true;\n}\n\nState.onActivate = function onActivate(target, name, desc) {\n  if (typeof desc.value !== \"function\") {\n    throw \"@State.onActivate expects a function target\";\n  }\n\n  let meta = stateMeta(target.constructor);\n  meta.state.callbacks.onActivate.push(desc.value);\n};\n\nState.onAttach = function onAttach(target, name, desc) {\n  if (typeof desc.value !== \"function\") {\n    throw \"@State.onAttach expects a function target\";\n  }\n\n  let meta = stateMeta(target.constructor);\n  meta.state.callbacks.onAttach.push(desc.value);\n};\n\nState.onDetach = function onDetach(target, name, desc) {\n  if (typeof desc.value !== \"function\") {\n    throw \"@State.onDetach expects a function target\";\n  }\n\n  let meta = stateMeta(target.constructor);\n  meta.state.callbacks.onDetach.push(desc.value);\n};\n\nexport function mountAt(url, opts={}) {\n  let {name} = opts;\n\n  return {\n    state:              this,\n    url:                url,\n    name:               name,\n    buildUiRouterState: builder,\n  };\n\n  function builder() {\n    let state = buildUiRouterState(this.state);\n\n    if (this.url) {\n      state.url = url;\n    }\n\n    if (this.name) {\n      state.name = name;\n    }\n\n    return state;\n  }\n}\n\nexport function buildUiRouterState(obj) {\n  console.log(\"buildUiRouterState: %o\", obj);\n  if (!obj) {\n    return null;\n  }\n\n  if (obj.buildUiRouterState) {\n    let state = obj.buildUiRouterState();\n    console.log(\"State: => %o\", state);\n    return state;\n  }\n\n  let meta = funcMeta(obj);\n  if (!meta.state) {\n    throw Error(\"provided object is not a state\");\n  }\n\n  let children = [];\n  for (let child of meta.state.children) {\n    children.push(buildUiRouterState(child));\n  }\n\n  let state = {\n    name:         meta.state.name,\n    template:     meta.state.template,\n    templateUrl:  meta.state.templateUrl,\n    controllerAs: meta.state.bindTo,\n    url:          meta.state.url,\n    abstract:     meta.state.abstract,\n    children:     children,\n    controller:   [meta.state.name, '$locals', '$injector', '$scope', controllerAttacher],\n    resolve:      {\n      [meta.state.name]: ['$q', '$controller', '$locals', '$injector', controllerProvider],\n    },\n  };\n\n  console.log(\"State: => %o\", state);\n  return state;\n\n  function controllerAttacher(ctrl, $locals, $injector, $scope) {\n    for (let clb of meta.callbacks.onAttach) {\n      $injector.invoke(clb, ctrl, $locals);\n    }\n\n    $scope.$on(\"$destroy\", function() {\n      for (let clb of meta.callbacks.onDetach) {\n        $injector.invoke(clb, ctrl, $locals);\n      }\n    });\n\n    return ctrl;\n  }\n\n  function controllerProvider($q, $controller, $locals, $injector) {\n    let ctrl = $controller(meta.controller.name, $locals);\n    let p = $q.when(ctrl);\n\n    for (let clb of meta.callbacks.onActivate) {\n      p = p.then(() => $injector.invoke(clb, ctrl, $locals));\n    }\n\n    p = p.then(() => ctrl);\n    return p;\n  }\n}\n"]}